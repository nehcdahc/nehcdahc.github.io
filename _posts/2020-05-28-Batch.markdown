---
layout: post
title: "常用 Batch 脚本"
date: 2020-03-02 18:04:00 +0800
tags: [Batch]
categories: ["操作系统", "编程语言"]
---

## 如果需要以管理员身份运行 bat 文件

1. 检查权限，无权限退出

   ```batch
   rem 检查是否使用管理员权限
   echo Administrative permissions required. Detecting permissions...

   net session >nul 2>&1
   if %errorLevel% == 0 (
      echo Success: Administrative permissions confirmed.
   ) else (
      echo Failure: Current permissions inadequate.
      goto end
   )
   ```

1. elevate to admin and also stay in the correct directory. <https://stackoverflow.com/questions/6811372/how-to-code-a-bat-file-to-always-run-as-admin-mode>

   ```batch
   set "params=%*"
   cd /d "%~dp0" && ( if exist "%temp%\getadmin.vbs" del "%temp%\getadmin.vbs" ) && fsutil dirty query %systemdrive% 1>nul 2>nul || (  echo Set UAC = CreateObject^("Shell.Application"^) : UAC.ShellExecute "cmd.exe", "/k cd ""%~sdp0"" && %~s0 %params%", "", "runas", 1 >> "%temp%\getadmin.vbs" && "%temp%\getadmin.vbs" && exit /B )
   ```

## %cd% 与 %~dp0% 的区别

1. 使用范围

   - %cd%：.bat file、cmd
   - %~dp0%: .bat file

1. 示例脚本

   1. 创建文件 D:\cd~dp0.bat

      ```batch
      @echo off
      echo this is %%cd%% : %cd%
      echo this is %%~dp0 : %~dp0
      ```

   1. 在 C:\Users\Administrator 路径执行

      ```
      this is %cd% : C:\Users\Administrator
      this is %~dp0 : D:\
      ```

   1. 在 D:\ 路径执行

      ```
      this is %cd% : D:\
      this is %~dp0 : D:\
      ```

## 参考

- [bat 中%cd%和%~dp0 的区别]<https://blog.csdn.net/lolichan/article/details/84919982>
